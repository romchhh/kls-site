// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  SUPERADMIN
}

enum ShipmentStatusEnum {
  CREATED
  RECEIVED_CN
  CONSOLIDATION
  IN_TRANSIT
  ARRIVED_UA
  ON_UA_WAREHOUSE
  DELIVERED
  ARCHIVED
}

enum DeliveryType {
  AIR
  SEA
  RAIL
  MULTIMODAL
}

enum DeliveryFormat {
  NOVA_POSHTA
  SELF_PICKUP
  CARGO
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  phone         String
  name          String
  companyName   String?
  password      String   // hashed password
  clientCode    String   @unique // 4-digit client ID (XXXX)
  role          UserRole @default(USER)
  lastLogin     DateTime? // Last login timestamp
  actionsCount  Int      @default(0) // Count of actions performed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  shipments     Shipment[]
  invoices      Invoice[]
  transactions  Transaction[]
  adminActions  AdminAction[] // Track admin actions
  
  @@map("users")
}

model AdminAction {
  id          String   @id @default(cuid())
  adminId     String
  actionType  String   // "CREATE_USER", "DELETE_USER", "UPDATE_USER", etc.
  targetType  String?  // "USER", "ADMIN", etc.
  targetId    String?  // ID of the target (user/admin)
  description String?  // Description of the action
  metadata    String?  // JSON string for additional data
  createdAt   DateTime @default(now())
  
  admin       User     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  @@map("admin_actions")
}

model Shipment {
  id          String   @id @default(cuid())
  userId      String
  clientCode  String

  // Основні ідентифікатори
  internalTrack    String   @unique
  cargoLabel       String?
  status           ShipmentStatusEnum @default(CREATED)

  // Локація / маршрут
  location         String? // короткий опис, наприклад "CN warehouse", "UA warehouse"
  pieces           Int      @default(1) // кількість місць (коробок)
  routeFrom        String
  routeTo          String
  deliveryType     DeliveryType

  // Локальні треки
  localTrackingOrigin      String?
  localTrackingDestination String?

  // Опис та позиції
  description      String?
  mainPhotoUrl     String? // основне фото партії вантажу

  // Страхування
  insuranceTotal           Decimal? @db.Decimal(14, 2)
  insurancePercentTotal    Int?     // 2–20%
  insurancePerPlacePercent Int?

  // Вага та об'єм
  weightKg   Decimal? @db.Decimal(10, 3)
  volumeM3   Decimal? @db.Decimal(10, 4)
  density    Decimal? @db.Decimal(10, 3)

  // Тарифи та суми
  tariffType           String? // "kg" | "m3"
  tariffValue          Decimal? @db.Decimal(10, 2)
  deliveryCost         Decimal? @db.Decimal(14, 2)
  deliveryCostPerPlace Decimal? @db.Decimal(14, 2)
  totalCost            Decimal? @db.Decimal(14, 2)

  // Дати
  receivedAtWarehouse DateTime?
  sentAt              DateTime?
  deliveredAt         DateTime?
  eta                 DateTime?

  // Формат видачі
  deliveryFormat   DeliveryFormat?
  deliveryReference String? // номер накладної НП або коментар

  // Додаткові послуги
  packing              Boolean? // чи була послуга пакування
  localDeliveryToDepot Boolean? // локальна доставка до складу

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       ShipmentItem[]
  statusHistory ShipmentStatusHistory[]
  
  @@map("shipments")
}

model ShipmentItem {
  id          String   @id @default(cuid())
  shipmentId  String

  itemCode      String? // внутрішнє маркування позиції
  description   String?
  quantity      Int?     // кількість одиниць товару

  clientTariff  Decimal? @db.Decimal(10, 2) // тариф клієнта за одиницю/кг/м3
  insuranceValue Decimal? @db.Decimal(14, 2)

  weightKg   Decimal? @db.Decimal(10, 3)
  volumeM3   Decimal? @db.Decimal(10, 4)
  density    Decimal? @db.Decimal(10, 3)

  localTracking String?
  photoUrl      String?

  deliveryCost Decimal? @db.Decimal(14, 2)
  totalCost    Decimal? @db.Decimal(14, 2)

  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@map("shipment_items")
}

model ShipmentStatusHistory {
  id          String             @id @default(cuid())
  shipmentId  String
  status      ShipmentStatusEnum
  location    String?
  description String?
  createdAt   DateTime           @default(now())

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@map("shipment_status_history")
}

model Invoice {
  id          String   @id @default(cuid())
  userId      String
  invoiceNumber String @unique
  amount      Decimal  @db.Decimal(10, 2)
  status      String
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("invoices")
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  type        String   // income, expense
  amount      Decimal  @db.Decimal(10, 2)
  description String?
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("transactions")
}

model Warehouse {
  id          String   @id @default(cuid())
  name        String
  address     String
  city        String
  country     String
  phone       String?
  email       String?
  packingConditions String? // Text about packing conditions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("warehouses")
}

